# build stage
FROM node:22-alpine AS build

WORKDIR /app

# ‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå dependency ‡∏Å‡πà‡∏≠‡∏ô (cache ‡πÑ‡∏î‡πâ)
COPY package*.json ./

# ‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á dependency
RUN npm install

# ‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á Angular CLI
RUN npm install -g @angular/cli

# ‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å source code ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
COPY . .

# ‡∏™‡∏£‡πâ‡∏≤‡∏á production build
RUN npm run build -- --configuration production

# production stage
FROM nginx:stable-alpine

# ‡∏•‡∏ö‡πÑ‡∏ü‡∏•‡πå index.html ‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô nginx
RUN rm /usr/share/nginx/html/*

# ‡∏•‡∏ö config ‡πÄ‡∏î‡∏¥‡∏°‡∏Ç‡∏≠‡∏á nginx
RUN rm /etc/nginx/conf.d/default.conf

# ‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å nginx.conf ‡∏Ç‡∏≠‡∏á‡πÄ‡∏£‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏õ
COPY nginx.conf /etc/nginx/conf.d/default.conf

# üîç ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤ build ‡∏≠‡∏≠‡∏Å‡∏°‡∏≤‡∏ó‡∏µ‡πà dist/client ‡∏´‡∏£‡∏∑‡∏≠ dist/browser
# ‡πÉ‡∏ä‡πâ path ‡∏ô‡∏µ‡πâ‡∏ï‡∏≤‡∏°‡∏ó‡∏µ‡πà angular.json ‡∏£‡∏∞‡∏ö‡∏∏‡πÑ‡∏ß‡πâ
COPY --from=build /app/dist/client/browser /usr/share/nginx/html
